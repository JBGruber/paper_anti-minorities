---
title: 3_annotation
author: Johannes B. Gruber
date: today
format:
  html:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    embed-resources: true
---

# Introduction

- who is talking about LGBTQ?
- Is the statement referring to LGBTQ+ rights
- Is the statement using LGBTQ+ rights to draw boundaries between in-groups (natives) and out-groups (immigrants)?
- If so, who is the excluded group

prompt:

Analyze the following paragraph and answer these questions about it:

1. Is the statement referring to LGBTQ+ rights or issues? Answer only with {yes} or {no}

If yes:

2. Is this paragraph talking {positive} about LGBTQ+ rights or issues (e.g., as part of a broader commitment to equality and human rights) or {negative} about LGBTQ+ rights or issues (e.g., framing LGBTQ+ identities as deviant, harmful, or undesirable)
3. Which political party, or member thereof, is making the statement? Return only the party (e.g., {Labour})

If 2 is positive:

4. Is support for LGBTQ+ rights in this paragraph conditional. Specifically, is the support for LGBTQ+ issues framed within the context of immigration or ethnonationalism.

Only give factual answers to the question. If there is no correct answer based on the text, return NA. Do not make things up.

## Packages

I use httr2 to pull articles from the Guardian API.

```{r setup}
#| include: false
library(tidyverse)
library(glue)
library(rollama)
start <- Sys.time() # note start time for later
prototype <- FALSE
```

## Data

```{r}
paragraphs <- readRDS("data/lgbtq_party_paragraphs.rds") |> 
  filter(nchar(text) < 1000)
if (prototype) {
  set.seed(1)
  paragraphs <- paragraphs |> 
    sample_n(20)
}
```


# Main

I retain only paragraphs that feature both a keyword from the LGBTQ list and one from the party list.


```{r}
prompt1 <- "Is the paragraph below referring to LGBTQ+ rights or issues? Answer only with {yes} or {no}"
# If yes:

prompt2 <- "Is the paragraph below talking positivly about LGBTQ+ rights or issues (e.g., as part of a broader commitment to equality and human rights) or negatively about LGBTQ+ rights or issues (e.g., framing LGBTQ+ identities as deviant, harmful, or undesirable)? Anser only with {positive} or {negative}"
prompt3 <- "Which political party, or member thereof, is making a statement in the paragraph below? Return only the party (e.g., {Labour})"
# If 2 is positive:
prompt4 <- "Is support for LGBTQ+ rights in the paragraph below conditional. Specifically, is the support for LGBTQ+ issues framed within the context of immigration or ethnonationalism. Answer only with {yes} or {no}"
```
TODO:

- ask category specifically
- ask 4 (and 5) seperately
- only check homonationalism

```{r}
system_prompt <- "Give factual answers to the questions posed by the user. If there is no correct answer based on the text, return {NA}. Do not make things up, only provide the answers."


annotate_1 <- function(txt) {
  
  prompt1 <- "Is the paragraph below referring to LGBTQ+ rights or issues? Answer only with {yes} or {no}"
  
  queries <- map(txt, function(t) {
    tribble(
      ~role, ~content,
      "system", glue("{system_prompt}\n\n{prompt1}"),
      "user", "Here is the paragraph:\n\n\"As a society, we have made significant progress on LGBTQ+ rights, ensuring that every individual, regardless of their gender or sexuality, is treated equally under the law. Labour is committed to continuing this work for a more inclusive future.\"",
      "assistant", "{yes}",
      "user", "Here is the paragraph:\n\n\"The Conservative Party stands firmly in support of LGBTQ+ rights. However, we must acknowledge that certain immigrant groups hold values that conflict with our commitment to equality, and we need to address these differences to protect our nation's liberal principles.\"",
      "assistant", "{yes}",
      "user", "Here is the paragraph:\n\n\"The Green Party is focused on addressing transgender rights, climate change and economic inequality.\"",
      "assistant","{yes}",
      "user", glue("Here is the paragraph:\n\n\"{t}\"")
    )
  })
  
  out <- query(
    q = queries,
    screen = FALSE,
    model = "llama3.1:8b-instruct-q8_0", 
    output = "text",
    #format = "json",
    model_params = list(seed = 42, temperature = 0)
  )
  if (interactive()) cli::cli_alert_success("annotation 1 done")
  return(out)
}

annotate_2 <- function(txt) {

  prompt2 <- "Is the paragraph below talking positivly about LGBTQ+ rights or issues (e.g., as part of a broader commitment to equality and human rights) or negatively about LGBTQ+ rights or issues (e.g., framing LGBTQ+ identities as deviant, harmful, or undesirable)? Anser only with {positive} or {negative}"
  
  queries <- map(txt, function(t) {
    tribble(
      ~role, ~content,
      "system", glue("{system_prompt}\n\n{prompt2}"),
      "user", "Here is the paragraph:\n\n\"As a society, we have made significant progress on LGBTQ+ rights, ensuring that every individual, regardless of their gender or sexuality, is treated equally under the law. Labour is committed to continuing this work for a more inclusive future.\"",
      "assistant", "{Labour}",
      "user", "Here is the paragraph:\n\n\"The Conservative Party stands firmly in support of LGBTQ+ rights. However, we must acknowledge that certain immigrant groups hold values that conflict with our commitment to equality, and we need to address these differences to protect our nation's liberal principles.\"",
      "assistant", "{yes}",
      "user", "Here is the paragraph:\n\n\"The Green Party is focused on addressing transgender rights, climate change and economic inequality.\"",
      "assistant","{yes}",
      "user", glue("Here is the paragraph:\n\n\"{t}\"")
    )
  })
  
  out <- query(
    q = queries,
    screen = FALSE,
    model = "llama3.1:8b-instruct-q8_0", 
    output = "text",
    #format = "json",
    model_params = list(seed = 42, temperature = 0)
  )
  if (interactive()) cli::cli_alert_success("annotation 2 done")
  return(out)
  
}

annotate_3 <- function(txt) {
  
  prompt3 <- "Which political party, or member thereof, is making a statement in the paragraph below? Return only the party (e.g., {Labour})"
  
  queries <- map(txt, function(t) {
    tribble(
      ~role, ~content,
      "system", glue("{system_prompt}\n\n{prompt3}"),
      "user", "Here is the paragraph:\n\n\"As a society, we have made significant progress on LGBTQ+ rights, ensuring that every individual, regardless of their gender or sexuality, is treated equally under the law. Labour is committed to continuing this work for a more inclusive future.\"",
      "assistant", "{Labour}",
      "user", "nHere is the paragraph:\n\n\"The Conservative Party stands firmly in support of LGBTQ+ rights. However, we must acknowledge that certain immigrant groups hold values that conflict with our commitment to equality, and we need to address these differences to protect our nation's liberal principles.\"",
      "assistant", "{Conservative Party}",
      "user", "Here is the paragraph:\n\n\"The Green Party is focused on addressing transgender rights, climate change and economic inequality.\"",
      "assistant","{Green Party}",
      "user", glue("Here is the paragraph:\n\n\"{t}\"")
    )
  })
  
  out <- query(
    q = queries,
    screen = FALSE,
    model = "llama3.1:8b-instruct-q8_0", 
    output = "text",
    #format = "json",
    model_params = list(seed = 42, temperature = 0)
  )
  if (interactive()) cli::cli_alert_success("annotation 3 done")
  return(out)
  
}

annotate_4 <- function(txt) {
  
  prompt4 <- "Is the paragraph below negativly referring to immigration or immigrants? Answer {Yes} or {No}."
  
  queries <- map(txt, function(t) {
    tribble(
      ~role, ~content,
      "system", glue("{system_prompt}"),
      "user", glue("{prompt4}\n\nHere is the paragraph:\n\n\"As a society, we have made significant progress on LGBTQ+ rights, ensuring that every individual, regardless of their gender or sexuality, is treated equally under the law. Labour is committed to continuing this work for a more inclusive future.\""),
      "assistant", "{no}",
      "user", glue("{prompt4}\n\nHere is the paragraph:\n\n\"The Conservative Party stands firmly in support of LGBTQ+ rights. However, we must acknowledge that certain immigrant groups hold values that conflict with our commitment to equality, and we need to address these differences to protect our nation's liberal principles.\""),
      "assistant", "{yes}",
      "user", glue("{prompt4}\n\nHere is the paragraph:\n\n\"The Green Party is focused on addressing transgender rights, climate change and economic inequality.\""),
      "assistant","{no}",
      "user", glue("{prompt4}Here is the paragraph:\n\n\"{t}\"")
    )
  })
  
  out <- query(
    q = queries,
    screen = FALSE,
    model = "llama3.1:8b-instruct-q8_0", 
    output = "text",
    #format = "json",
    model_params = list(seed = 42, temperature = 0)
  )
  if (interactive()) cli::cli_alert_success("annotation 4 done")
  return(out)
  
}

annotate_5 <- function(txt) {
  
  prompt5 <- "Is support for LGBTQ+ rights in the paragraph below conditional. Specifically, is the support for LGBTQ+ issues framed within the context of immigration or ethnonationalism?"
  
  queries <- map(txt, function(t) {
    tribble(
      ~role, ~content,
      "system", "{system_prompt}\n\n{prompt5}",
      "user", "Here is the paragraph:\n\n\"As a society, we have made significant progress on LGBTQ+ rights, ensuring that every individual, regardless of their gender or sexuality, is treated equally under the law. Labour is committed to continuing this work for a more inclusive future.\"",
      "assistant", "{no}",
      "user", "Here is the paragraph:\n\n\"The Conservative Party stands firmly in support of LGBTQ+ rights. However, we must acknowledge that certain immigrant groups hold values that conflict with our commitment to equality, and we need to address these differences to protect our nation's liberal principles.\"",
      "assistant", "{yes}",
      "user", "Here is the paragraph:\n\n\"The Green Party is focused on addressing transgender rights, climate change and economic inequality.\"",
      "assistant","{no}",
      "user", glue("Here is the paragraph:\n\n\"{t}\"")
    )
  })
  
  out <- query(
    q = queries,
    screen = FALSE,
    model = "llama3.1:8b-instruct-q8_0", 
    output = "text",
    #format = "json",
    model_params = list(seed = 42, temperature = 0)
  )
  if (interactive()) cli::cli_alert_success("annotation 4 done")
  return(out)
  
}
```

This retains:

```{r}
paragraphs_annotated2 <- paragraphs |> 
  head(100) |> 
  mutate(
    # lgbtq = annotate_1(txt = text),
    # positive = annotate_2(txt = text),
    # party = annotate_3(txt = text),
    antiimmigrant = annotate_4(txt = text)
  )
```

```{r}
#| eval: false
#| echo: false
paragraphs_annotated_tidy <- paragraphs_annotated |> 
  rowwise() |> 
  mutate(annotation = str_extract(annotation, "\\{.+?\\}"),
         annotation = list(fromJSON(annotation))) |> 
  unnest_wider(annotation)

paragraphs_annotated_tidy |> 
  select(-id, -par_id, -word, -set, -query) |> 
  View("annotated")
```


# Wrap-up

```{r}
saveRDS(paragraphs_annotated, "data/lgbtq_party_paragraphs_annotated.rds")
```

Afterwards we get some information which is important to reproduce the report.

```{r}
sessionInfo()
Sys.time()
# note how long the script takes to (re-)run
Sys.time() - start
```
